---
title: "ARAVO"
author: "Apolline Saint-Pierre"
date: "2025-09-27"
output: html_document
---

```{r}
rel2001 = REL2001
rel2022 = REL2022
meta = META
rel2001
```

## R Markdown


```{r}
# Charger les packages
library(readxl)
library(dplyr)
library(vegan)
library(cluster)
```


```{r}
# Filtrer les ID comparables : yes/yes dans meta
valid_ids <- meta %>%
  filter(DATA_2001 == "yes" & DATA_2022 == "yes") %>%
  pull(ID)

rel2001 <- rel2001 %>% filter(ID %in% valid_ids)
rel2022 <- rel2022 %>% filter(ID %in% valid_ids)
```


```{r}
# Ajouter une colonne "Year"
rel2001$Year <- 2001
rel2022$Year <- 2022
```

```{r}
# Supprimer les colonnes non pertinentes (sommes, completed...)
rel2001_clean <- rel2001 %>%
  select(-SOMME)

rel2022_clean <- rel2022 %>%
  select(-contains("COMPLETED"), -HABITAT)
```

```{r}
# Harmoniser les noms des colonnes espèces
common_species <- intersect(names(rel2001_clean), names(rel2022_clean))
meta_cols <- c("ROW","COL","ID","Year")
species_cols <- setdiff(common_species, meta_cols)

rel2001_clean <- rel2001_clean %>% select(all_of(meta_cols), all_of(species_cols))
rel2022_clean <- rel2022_clean %>% select(all_of(meta_cols), all_of(species_cols))

```


```{r}
# S'assurer que toutes les colonnes espèces sont du même type (numeric)
for (col in species_cols) {
  rel2001_clean[[col]] <- as.numeric(rel2001_clean[[col]])
  rel2022_clean[[col]] <- as.numeric(rel2022_clean[[col]])
}

# Supprimer les lignes contenant des NA
rel2001_clean <- rel2001_clean %>% drop_na(all_of(species_cols))
rel2022_clean <- rel2022_clean %>% drop_na(all_of(species_cols))


# Fusionner les deux jeux
all_data <- bind_rows(rel2001_clean, rel2022_clean)
all_data
```

```{r}

# Supprimer la colonne "Sol nu" si elle existe

if("Sol nu" %in% names(all_data)) {
  all_data <- all_data %>% select(-`Sol nu`)
}

# Mettre à jour la liste des colonnes espèces
species_cols_filtered <- setdiff(species_cols, "Sol nu")

# Supprimer les lignes où aucune espèce restante n'est présente
all_data <- all_data %>% filter(rowSums(select(., all_of(species_cols_filtered))) > 0)

# Supprimer les lignes contenant des NA (sécurité)
all_data <- all_data %>% drop_na(all_of(species_cols_filtered))

# Identifier ID communes
common_IDs <- intersect(rel2001_clean$ID, rel2022_clean$ID)

# Filtrer les deux jeux pour ne garder que les ID communes
rel2001_common <- rel2001_clean %>% filter(ID %in% common_IDs)
rel2022_common <- rel2022_clean %>% filter(ID %in% common_IDs)

# Fusionner
all_data_common <- bind_rows(rel2001_common, rel2022_common)

# Supprimer les NA par sécurité
all_data_common <- all_data_common %>% drop_na(all_of(species_cols_filtered))
```


```{r}
all_data_common
```

```{r}

# Supprimer lignes vides
all_data_common_clean <- all_data_common %>%
  filter(rowSums(select(., all_of(species_cols_filtered))) > 0)

# --- 2. Matrice présence/absence ---
comm_matrix <- as.matrix(all_data_common_clean[, species_cols_filtered])
comm_matrix_bin <- (comm_matrix > 0) * 1


# Garder les IDs correspondant aux lignes conservées
keep_rows <- rowSums(comm_matrix_bin) > 0
comm_matrix_bin <- comm_matrix_bin[keep_rows, ]
final_IDs <- all_data_common_clean$ID[keep_rows]
years <- all_data_common_clean$Year[keep_rows]

# --- 3. Calcul de la distance Jaccard ---
dist_jac <- vegdist(comm_matrix_bin, method = "jaccard")

# --- 4. Clustering hiérarchique ---
clust <- hclust(dist_jac, method = "ward.D2")

# Visualisation rapide
plot(clust, labels = final_IDs, main = "Dendrogramme Jaccard", hang = -1, cex = 0.8)
```
```{r}
# --- 5. Choix du nombre de clusters avec silhouette ---
k_max <- 10
sil_scores <- sapply(2:k_max, function(k) {
  cluster_assign <- cutree(clust, k)
  silhouette(cluster_assign, dist_jac) %>% summary() %>% .$avg.width
})
best_k <- which.max(sil_scores) + 1
cat("Nombre optimal de clusters selon silhouette :", best_k, "\n")

```

```{r}
# Découper l'arbre
cluster_assign <- cutree(clust, k = best_k)

# --- 6. Ajouter les clusters à la table ---
all_data_common_clean <- all_data_common_clean[keep_rows, ]  # filtrer les lignes correspondant à comm_matrix_bin
all_data_common_clean$Cluster <- cluster_assign
```

```{r}
# --- 7. Joindre les coordonnées Lambert 93 depuis meta ---
# meta doit contenir : ID, X_L93, Y_L93
final_table <- all_data_common_clean %>%
  left_join(meta %>% select(ID, X_L93, Y_L93), by = "ID") %>%
  select(ID, Year, X_L93, Y_L93, Cluster)
```

```{r}
# Vérifier le résultat
head(final_table)
```
```{r}
final_table
```
```{r}
library(writexl)

# Exporter la table finale en Excel dans ton dossier ARAVO
write_xlsx(final_table, path = "final_table_clusters.xlsx")

# Vérifier le répertoire de travail (optionnel)
getwd()

```
```{r}
library(dplyr)
library(writexl)

# Calcul de la moyenne d'abondance (ou fréquence de présence) par cluster
species_by_cluster <- all_data_common_clean %>%
  group_by(Cluster) %>%
  summarise(across(all_of(species_cols_filtered), \(x) mean(x, na.rm = TRUE)))

```

```{r}
species_presence <- (species_by_cluster > 0) * 1
species_presence <- cbind(Cluster = species_by_cluster$Cluster, species_presence)
```

```{r}
write_xlsx(species_by_cluster, path = "species_by_cluster.xlsx")
```

```{r}
library(dplyr)
library(tidyr)
library(writexl)

# Calcul de la fréquence d'occurrence (% des placettes du cluster où l'espèce est présente)
species_freq <- all_data_common_clean %>%
  group_by(Cluster) %>%
  summarise(across(all_of(species_cols_filtered),
                   \(x) 100 * sum(x > 0, na.rm = TRUE) / n()))
```

```{r}
species_freq_long <- species_freq %>%
  pivot_longer(
    -Cluster,
    names_to = "Espece",
    values_to = "Frequence"
  ) %>%
  arrange(Cluster, desc(Frequence))
```




```{r}
write_xlsx(species_freq_long, path = "species_frequence_by_cluster.xlsx")
```


```{r}
library(dplyr)
library(tidyr)
library(ggplot2)

```


```{r}
species_freq_long <- species_freq %>%
  pivot_longer(
    -Cluster,
    names_to = "Espece",
    values_to = "Frequence"
  )
```

```{r}
ggplot(species_freq_long, aes(x = Espece, y = factor(Cluster), fill = Frequence)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "darkgreen", name = "Fréquence (%)") +
  labs(
    title = "Fréquence des espèces par cluster",
    x = "Espèces",
    y = "Clusters"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1, size = 9),
    axis.text.y = element_text(size = 10),
    panel.grid = element_blank()
  )
```

```{r}
top_species <- species_freq_long %>%
  group_by(Espece) %>%
  summarise(MaxFreq = max(Frequence)) %>%
  arrange(desc(MaxFreq)) %>%
  slice_head(n = 20) %>%
  pull(Espece)

species_freq_top <- species_freq_long %>%
  filter(Espece %in% top_species)

ggplot(species_freq_top, aes(x = Espece, y = factor(Cluster), fill = Frequence)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "darkgreen", name = "Fréquence (%)") +
  labs(
    title = "Top 20 espèces les plus fréquentes par cluster",
    x = "Espèces",
    y = "Clusters"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1, size = 9),
    axis.text.y = element_text(size = 10),
    panel.grid = element_blank()
  )
```





