---
title: "ARAVO"
author: "Apolline Saint-Pierre"
date: "2025-09-27"
output: html_document
---

```{r}

library(readxl)
REL2001 <- read_excel("ARAVO_RESURVEY_GRID.xlsx", 
    sheet = "REL2001")
View(REL2001)
library(readxl)
REL2022 <- read_excel("ARAVO_RESURVEY_GRID.xlsx", 
    sheet = "REL2022")
View(REL2022)
library(readxl)
META <- read_excel("ARAVO_RESURVEY_GRID.xlsx", 
    sheet = "META")
View(META)
```



```{r}
rel2001 = REL2001
rel2022 = REL2022
meta = META
rel2001
```

## R Markdown


```{r}
# Charger les packages
library(readxl)
library(dplyr)
library(vegan)
library(cluster)
```


```{r}
# Filtrer les ID comparables : yes/yes dans meta
valid_ids <- meta %>%
  filter(DATA_2001 == "yes" & DATA_2022 == "yes") %>%
  pull(ID)

rel2001 <- rel2001 %>% filter(ID %in% valid_ids)
rel2022 <- rel2022 %>% filter(ID %in% valid_ids)
```


```{r}
# Ajouter une colonne "Year"
rel2001$Year <- 2001
rel2022$Year <- 2022
```

```{r}
# Supprimer les colonnes non pertinentes (sommes, completed...)
rel2001_clean <- rel2001 %>%
  select(-SOMME)

rel2022_clean <- rel2022 %>%
  select(-contains("COMPLETED"), -HABITAT)
```

```{r}
# Harmoniser les noms des colonnes esp√®ces
common_species <- intersect(names(rel2001_clean), names(rel2022_clean))
meta_cols <- c("ROW","COL","ID","Year")
species_cols <- setdiff(common_species, meta_cols)

rel2001_clean <- rel2001_clean %>% select(all_of(meta_cols), all_of(species_cols))
rel2022_clean <- rel2022_clean %>% select(all_of(meta_cols), all_of(species_cols))

```


```{r}
# S'assurer que toutes les colonnes esp√®ces sont du m√™me type (numeric)
for (col in species_cols) {
  rel2001_clean[[col]] <- as.numeric(rel2001_clean[[col]])
  rel2022_clean[[col]] <- as.numeric(rel2022_clean[[col]])
}

# Supprimer les lignes contenant des NA
rel2001_clean <- rel2001_clean %>% drop_na(all_of(species_cols))
rel2022_clean <- rel2022_clean %>% drop_na(all_of(species_cols))


# Fusionner les deux jeux
all_data <- bind_rows(rel2001_clean, rel2022_clean)
all_data
```

```{r}

# Supprimer la colonne "Sol nu" si elle existe

if("Sol nu" %in% names(all_data)) {
  all_data <- all_data %>% select(-`Sol nu`)
}

# Mettre √† jour la liste des colonnes esp√®ces
species_cols_filtered <- setdiff(species_cols, "Sol nu")

# Supprimer les lignes o√π aucune esp√®ce restante n'est pr√©sente
all_data <- all_data %>% filter(rowSums(select(., all_of(species_cols_filtered))) > 0)

# Supprimer les lignes contenant des NA (s√©curit√©)
all_data <- all_data %>% drop_na(all_of(species_cols_filtered))

# Identifier ID communes
common_IDs <- intersect(rel2001_clean$ID, rel2022_clean$ID)

# Filtrer les deux jeux pour ne garder que les ID communes
rel2001_common <- rel2001_clean %>% filter(ID %in% common_IDs)
rel2022_common <- rel2022_clean %>% filter(ID %in% common_IDs)

# Fusionner
all_data_common <- bind_rows(rel2001_common, rel2022_common)

# Supprimer les NA par s√©curit√©
all_data_common <- all_data_common %>% drop_na(all_of(species_cols_filtered))
```


```{r}
all_data_common
```

```{r}

# Supprimer lignes vides
all_data_common_clean <- all_data_common %>%
  filter(rowSums(select(., all_of(species_cols_filtered))) > 0)

# --- 2. Matrice pr√©sence/absence ---
comm_matrix <- as.matrix(all_data_common_clean[, species_cols_filtered])
comm_matrix_bin <- (comm_matrix > 0) * 1


# Garder les IDs correspondant aux lignes conserv√©es
keep_rows <- rowSums(comm_matrix_bin) > 0
comm_matrix_bin <- comm_matrix_bin[keep_rows, ]
final_IDs <- all_data_common_clean$ID[keep_rows]
years <- all_data_common_clean$Year[keep_rows]

# --- 3. Calcul de la distance Jaccard ---
dist_jac <- vegdist(comm_matrix_bin, method = "jaccard")

# --- 4. Clustering hi√©rarchique ---
clust <- hclust(dist_jac, method = "ward.D2")

# Visualisation rapide
plot(clust, labels = final_IDs, main = "Dendrogramme Jaccard", hang = -1, cex = 0.8)
```
```{r}
# --- 5. Choix du nombre de clusters avec silhouette ---
k_max <- 10
sil_scores <- sapply(2:k_max, function(k) {
  cluster_assign <- cutree(clust, k)
  silhouette(cluster_assign, dist_jac) %>% summary() %>% .$avg.width
})
best_k <- which.max(sil_scores) + 1
cat("Nombre optimal de clusters selon silhouette :", best_k, "\n")

```

```{r}
# D√©couper l'arbre
cluster_assign <- cutree(clust, k = best_k)

# --- 6. Ajouter les clusters √† la table ---
all_data_common_clean <- all_data_common_clean[keep_rows, ]  # filtrer les lignes correspondant √† comm_matrix_bin
all_data_common_clean$Cluster <- cluster_assign
all_data_common_clean

``{r}
library(writexl)

# Exporter la table finale en Excel dans ton dossier ARAVO
write_xlsx(all_data_common_clean, path = "all_data_common_clean.xlsx")


```

```{r}
# --- 7. Joindre les coordonn√©es Lambert 93 depuis meta ---
# meta doit contenir : ID, X_L93, Y_L93
final_table <- all_data_common_clean %>%
  left_join(meta %>% select(ID, X_L93, Y_L93), by = "ID") %>%
  select(ID, Year, X_L93, Y_L93, Cluster)
```




```{r}
# --- 7. Joindre les coordonn√©es Lambert 93 depuis meta ---
# meta doit contenir : ID, X_L93, Y_L93
final_salix_herb <- all_data_common_clean %>%
  left_join(meta %>% select(ID, X_L93, Y_L93), by = "ID") %>%
  select(ID, Year, X_L93, Y_L93, `Care myos`, `Sali herb`)
final_salix_herb

library(writexl)

# Exporter la table finale en Excel dans ton dossier ARAVO
write_xlsx(final_salix_herb, path = "final_salix_herb.xlsx")
```





```{r}
# V√©rifier le r√©sultat
head(final_table)
```
```{r}
final_table
```
```{r}
library(writexl)

# Exporter la table finale en Excel dans ton dossier ARAVO
write_xlsx(final_table, path = "final_table_clusters.xlsx")

# V√©rifier le r√©pertoire de travail (optionnel)
getwd()

```
```{r}
library(dplyr)
library(writexl)

# Calcul de la moyenne d'abondance (ou fr√©quence de pr√©sence) par cluster
species_by_cluster <- all_data_common_clean %>%
  group_by(Cluster) %>%
  summarise(across(all_of(species_cols_filtered), \(x) mean(x, na.rm = TRUE)))

```

```{r}
species_presence <- (species_by_cluster > 0) * 1
species_presence <- cbind(Cluster = species_by_cluster$Cluster, species_presence)
```

```{r}
write_xlsx(species_by_cluster, path = "species_by_cluster.xlsx")
```

```{r}
library(dplyr)
library(tidyr)
library(writexl)

# Calcul de la fr√©quence d'occurrence (% des placettes du cluster o√π l'esp√®ce est pr√©sente)
species_freq <- all_data_common_clean %>%
  group_by(Cluster) %>%
  summarise(across(all_of(species_cols_filtered),
                   \(x) 100 * sum(x > 0, na.rm = TRUE) / n()))
```

```{r}
species_freq_long <- species_freq %>%
  pivot_longer(
    -Cluster,
    names_to = "Espece",
    values_to = "Frequence"
  ) %>%
  arrange(Cluster, desc(Frequence))
```




```{r}
write_xlsx(species_freq_long, path = "species_frequence_by_cluster.xlsx")
```


```{r}
library(dplyr)
library(tidyr)
library(ggplot2)

```


```{r}
species_freq_long <- species_freq %>%
  pivot_longer(
    -Cluster,
    names_to = "Espece",
    values_to = "Frequence"
  )
```

```{r}
ggplot(species_freq_long, aes(x = Espece, y = factor(Cluster), fill = Frequence)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "darkgreen", name = "Fr√©quence (%)") +
  labs(
    title = "Fr√©quence des esp√®ces par cluster",
    x = "Esp√®ces",
    y = "Clusters"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1, size = 9),
    axis.text.y = element_text(size = 10),
    panel.grid = element_blank()
  )
```

```{r}
top_species <- species_freq_long %>%
  group_by(Espece) %>%
  summarise(MaxFreq = max(Frequence)) %>%
  arrange(desc(MaxFreq)) %>%
  slice_head(n = 20) %>%
  pull(Espece)

species_freq_top <- species_freq_long %>%
  filter(Espece %in% top_species)

ggplot(species_freq_top, aes(x = Espece, y = factor(Cluster), fill = Frequence)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "darkgreen", name = "Fr√©quence (%)") +
  labs(
    title = "Top 20 esp√®ces les plus fr√©quentes par cluster",
    x = "Esp√®ces",
    y = "Clusters"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1, size = 9),
    axis.text.y = element_text(size = 10),
    panel.grid = element_blank()
  )
```




```{r}
# Filtrer les deux jeux pour ne garder que les ID communes
rel2001_common <- rel2001_clean %>% filter(ID %in% common_IDs)
rel2022_common <- rel2022_clean %>% filter(ID %in% common_IDs)

rel2001_common

```


```{r}
rel2022_common
```



```{r}
# -----------------------------------------------------------
# ‚öôÔ∏è Chargement des librairies n√©cessaires
# -----------------------------------------------------------
library(ade4)
library(ggplot2)
library(dplyr)

# -----------------------------------------------------------
# üß≠ V√©rification de la correspondance des lignes
# -----------------------------------------------------------
# Les ID doivent √™tre dans le m√™me ordre
all(rownames(rel2001_common) == rownames(rel2022_common))
# Si FALSE ‚Üí r√©aligner :
# rel2022_common <- rel2022_common[match(rownames(rel2001_common), rownames(rel2022_common)), ]

# -----------------------------------------------------------
# üìä 1. ACP sur chaque tableau
# -----------------------------------------------------------
# S√©lectionne uniquement les colonnes num√©riques correspondant aux esp√®ces
rel2001_common_num <- rel2001_common %>% 
  dplyr::select(-ROW, -COL, -ID, -Year)

rel2022_common_num <- rel2022_common %>% 
  dplyr::select(-ROW, -COL, -ID, -Year)


rel2001_common_num[is.na(rel2001_common_num)] <- 0
rel2022_common_num[is.na(rel2022_common_num)] <- 0


library(ade4)
# ACP pour chaque ann√©e
pca2001 <- dudi.pca(rel2001_common_num, scannf = FALSE, nf = 3)
pca2022 <- dudi.pca(rel2022_common_num, scannf = FALSE, nf = 3)

# Co-inertie
coin <- coinertia(pca2001, pca2022, scannf = FALSE)

# R√©sum√© et graphique
summary(coin)
plot(coin)

# -----------------------------------------------------------
# üîó 2. Analyse de co-inertie
# -----------------------------------------------------------
coin <- coinertia(pca2001, pca2022, scannf = FALSE)

# R√©sum√© des r√©sultats
summary(coin)

```

```{r}
# -----------------------------------------------------------
# üìà 3. Visualisations principales
# -----------------------------------------------------------
# Inertie commune

???????
# -----------------------------------------------------------
# üß† 4. Interpr√©tation
# -----------------------------------------------------------
# Coefficient RV (corr√©lation globale entre structures)
RV <- RV.rtest(pca2001$tab, pca2022$tab)
RV
plot(RV)

# -----------------------------------------------------------
# üíæ 5. Sauvegarde des coordonn√©es si besoin
# -----------------------------------------------------------
coords <- as.data.frame(coin$ls)
coords$ID <- rownames(rel2001_common)
write.csv(coords, "co_inertia_coordinates.csv", row.names = FALSE)
```



# Ici la cr√©ation de la feuille pr√©cence et absence pour salix et carex 


```{r}
# Packages
library(tidyverse)

# On part de ton data.frame d√©j√† charg√©
df <- final_salix_herb

# Renommer pour simplifier
df <- df %>%
  rename(
    Carex = `Care myos`,
    Salix = `Sali herb`
  )

# V√©rification
glimpse(df)
```

```{r}
# Table crois√©e de co-occurrence
tab <- table(df$Carex, df$Salix)
tab
```


```{r}
chisq.test(tab)
```
```{r}
fisher.test(tab)
```

```{r}
# Graphique de cooccurrence
df %>%
  count(Carex, Salix) %>%
  ggplot(aes(x = factor(Salix), y = factor(Carex), size = n, color = n)) +
  geom_point() +
  scale_size(range = c(3,10)) +
  theme_minimal() +
  labs(x = "Salix herbacea (0=abs, 1=pres)",
       y = "Carex myosuroides (0=abs, 1=pres)",
       title = "Co-occurrence des deux esp√®ces")
```


```{r}
ggplot(df, aes(x = X_L93, y = Y_L93, color = interaction(Carex, Salix))) +
  geom_point(size = 3) +
  scale_color_manual(values = c("grey50", "orange", "blue", "green"),
                     labels = c("Aucune", "Carex seule", "Salix seule", "Les deux")) +
  theme_minimal() +
  labs(title = "Distribution spatiale des co-occurrences",
       color = "Pr√©sence des esp√®ces")
```

```{r}
cor.test(df$Carex, df$Salix, method = "spearman")  # test de corr√©lation non param√©trique

```

```{r}
library(tidyverse)

df <- final_salix_herb %>%
  rename(
    Carex = `Care myos`,
    Salix = `Sali herb`
  )

# V√©rification
unique(df$Year)

# ------------------------
# 2Ô∏è‚É£ Test de cooccurrence s√©par√© par ann√©e
# ------------------------

# --- Pour 2001 ---
df_2001 <- df %>% filter(Year == 2001)
tab_2001 <- table(df_2001$Carex, df_2001$Salix)
tab_2001

test_2001 <- fisher.test(tab_2001)
test_2001

# --- Pour 2022 ---
df_2022 <- df %>% filter(Year == 2022)
tab_2022 <- table(df_2022$Carex, df_2022$Salix)
tab_2022

test_2022 <- fisher.test(tab_2022)
test_2022

# ------------------------
# 3Ô∏è‚É£ R√©sum√© des r√©sultats
# ------------------------
results <- tibble(
  Year = c(2001, 2022),
  p_value = c(test_2001$p.value, test_2022$p.value),
  odds_ratio = c(test_2001$estimate, test_2022$estimate),
  CI_low = c(test_2001$conf.int[1], test_2022$conf.int[1]),
  CI_high = c(test_2001$conf.int[2], test_2022$conf.int[2])
)

print(results)
```

En 2001
L‚Äôodds ratio < 1 (0.63) sugg√®re une tendance √† l‚Äôexclusion,

üëâ mais pas significative statistiquement (p = 0.12).
Autrement dit, en 2001, Salix herbacea et Carex myosuroides pouvaient coexister dans certains plots, sans qu‚Äôon d√©tecte un sch√©ma clair d‚Äôexclusion ou d‚Äôassociation.

En 2022

L‚Äôodds ratio chute √† 0.21, et le test devient hautement significatif (p < 0.001).
Cela signifie qu‚Äôen 2022, les deux esp√®ces sont nettement moins souvent retrouv√©es ensemble qu‚Äôattendu al√©atoirement.
‚Üí Leur co-occurrence a diminu√© dans le temps.





```{r}

# -------------------------------
library(tidyverse)
library(ggplot2)
library(patchwork)  # pour mettre deux cartes c√¥te √† c√¥te

# -------------------------------
# 2Ô∏è‚É£ Pr√©paration des donn√©es
# -------------------------------
df <- final_salix_herb %>%
  rename(
    Carex = `Care myos`,
    Salix = `Sali herb`
  ) %>%
  mutate(
    combo = case_when(
      Carex == 1 & Salix == 1 ~ "Les deux",
      Carex == 1 & Salix == 0 ~ "Carex seule",
      Carex == 0 & Salix == 1 ~ "Salix seule",
      TRUE ~ "Aucune"
    )
  )

# -------------------------------
# 3Ô∏è‚É£ S√©parer les ann√©es
# -------------------------------
df_2001 <- df %>% filter(Year == 2001)
df_2022 <- df %>% filter(Year == 2022)

# -------------------------------
# 4Ô∏è‚É£ Cr√©er les cartes
# -------------------------------
carte_2001 <- ggplot(df_2001, aes(x = X_L93, y = Y_L93, color = combo)) +
  geom_point(size = 3, alpha = 0.8) +
  scale_color_manual(values = c("grey60", "orange", "blue", "green")) +
  theme_minimal() +
  coord_equal() +
  labs(title = "2001 - Distribution des esp√®ces",
       color = "Pr√©sence")

carte_2022 <- ggplot(df_2022, aes(x = X_L93, y = Y_L93, color = combo)) +
  geom_point(size = 3, alpha = 0.8) +
  scale_color_manual(values = c("grey60", "orange", "blue", "green")) +
  theme_minimal() +
  coord_equal() +
  labs(title = "2022 - Distribution des esp√®ces",
       color = "Pr√©sence")

# -------------------------------
# 5Ô∏è‚É£ Afficher c√¥te √† c√¥te
# -------------------------------
carte_2001 + carte_2022
```



```{r}
# -------------------------------
# 1Ô∏è‚É£ Packages n√©cessaires
# -------------------------------
library(tidyverse)
library(patchwork)  # pour combiner les cartes

# -------------------------------
# 2Ô∏è‚É£ Pr√©paration des donn√©es
# -------------------------------
df <- final_salix_herb %>%
  rename(
    Carex = `Care myos`,
    Salix = `Sali herb`
  ) %>%
  mutate(
    combo = case_when(
      Carex == 1 & Salix == 1 ~ "Les deux esp√®ces",
      Carex == 1 & Salix == 0 ~ "Carex seule",
      Carex == 0 & Salix == 1 ~ "Salix seule",
      TRUE ~ "Aucune des deux"
    )
  )

# -------------------------------
# 3Ô∏è‚É£ S√©parer les ann√©es
# -------------------------------
df_2001 <- df %>% filter(Year == 2001)
df_2022 <- df %>% filter(Year == 2022)

# -------------------------------
# 4Ô∏è‚É£ D√©finir les couleurs et le th√®me
# -------------------------------
couleurs <- c(
  "Aucune des deux" = "grey70",
  "Carex seule" = "#E69F00",  # orange
  "Salix seule" = "#0072B2",  # bleu
  "Les deux esp√®ces" = "#009E73"  # vert
)

theme_carte <- theme_minimal(base_size = 13) +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.box = "horizontal",
    legend.text = element_text(size = 12),
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5)
  )

# -------------------------------
# 5Ô∏è‚É£ Cr√©er les cartes
# -------------------------------
carte_2001 <- ggplot(df_2001, aes(x = X_L93, y = Y_L93, color = combo)) +
  geom_point(size = 3, alpha = 0.85) +
  scale_color_manual(values = couleurs) +
  coord_equal() +
  theme_carte +
  labs(title = "2001")

carte_2022 <- ggplot(df_2022, aes(x = X_L93, y = Y_L93, color = combo)) +
  geom_point(size = 3, alpha = 0.85) +
  scale_color_manual(values = couleurs) +
  coord_equal() +
  theme_carte +
  labs(title = "2022")

# -------------------------------
# 6Ô∏è‚É£ Assembler les deux cartes
# -------------------------------
(carte_2001 + carte_2022) +
  plot_annotation(
    title = "Distribution spatiale de Carex myosuroides et Salix herbacea",
    subtitle = "Comparaison entre 2001 et 2022 dans l'√©cosyst√®me alpin de l'Aravo",
    theme = theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
                  plot.subtitle = element_text(size = 13, hjust = 0.5))
  )
```




# Ici on a la nouvelle version pour aravo completed 

```{r}
 df <- read.csv2("final_salix_carex2.0.csv", stringsAsFactors = FALSE)
df
```
```{r}
# Renommer pour simplifier
df <- df %>%
  rename(
    Carex = `Care.myos`,
    Salix = `Sali.herb`
  )

# V√©rification
glimpse(df)
```

```{r}
# Table crois√©e de co-occurrence
tab <- table(df$Carex, df$Salix)
tab
```

```{r}
# Graphique de cooccurrence
df %>%
  count(Carex, Salix) %>%
  ggplot(aes(x = factor(Salix), y = factor(Carex), size = n, color = n)) +
  geom_point() +
  scale_size(range = c(3,10)) +
  theme_minimal() +
  labs(x = "Salix herbacea (0=abs, 1=pres)",
       y = "Carex myosuroides (0=abs, 1=pres)",
       title = "Co-occurrence des deux esp√®ces")
```


```{r}
ggplot(df, aes(x = X_L93, y = Y_L93, color = interaction(Carex, Salix))) +
  geom_point(size = 3) +
  scale_color_manual(values = c("grey50", "orange", "blue", "green"),
                     labels = c("Aucune", "Carex seule", "Salix seule", "Les deux")) +
  theme_minimal() +
  labs(title = "Distribution spatiale des co-occurrences",
       color = "Pr√©sence des esp√®ces")
```



```{r}

# -------------------------------
# 1Ô∏è‚É£ Packages n√©cessaires
# -------------------------------
library(tidyverse)
library(patchwork) # pour combiner les cartes

# -------------------------------
# 2Ô∏è‚É£ Import et pr√©paration des donn√©es
# -------------------------------

# Lis ton fichier (format fran√ßais avec ;) :
df <- read.csv2("final_salix_carex2.0.csv", stringsAsFactors = FALSE)

# Renommer les colonnes pour simplifier
df <- df %>%
  rename(
    Carex = Care.myos,
    Salix = Sali.herb
  ) %>%
  mutate(
    # Cr√©er la variable "combo" selon la pr√©sence des deux esp√®ces
    combo = case_when(
      Carex == 1 & Salix == 1 ~ "Les deux esp√®ces",
      Carex == 1 & Salix == 0 ~ "Carex seule",
      Carex == 0 & Salix == 1 ~ "Salix seule",
      TRUE ~ "Aucune des deux"
    )
  )

# -------------------------------
# 3Ô∏è‚É£ S√©parer les ann√©es
# -------------------------------
df_2001 <- df %>% filter(Year == 2001)
df_2022 <- df %>% filter(Year == 2022)

# -------------------------------
# 4Ô∏è‚É£ D√©finir les couleurs et le th√®me
# -------------------------------
couleurs <- c(
  "Aucune des deux" = "grey70",
  "Carex seule" = "#E69F00",   # orange
  "Salix seule" = "#0072B2",   # bleu
  "Les deux esp√®ces" = "#009E73" # vert
)

theme_carte <- theme_minimal(base_size = 13) +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.box = "horizontal",
    legend.text = element_text(size = 12),
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5)
  )

# -------------------------------
# 5Ô∏è‚É£ Cr√©er les cartes
# -------------------------------
carte_2001 <- ggplot(df_2001, aes(x = X_L93, y = Y_L93, color = combo)) +
  geom_point(size = 3, alpha = 0.85) +
  scale_color_manual(values = couleurs) +
  coord_equal() +
  theme_carte +
  labs(title = "2001")

carte_2022 <- ggplot(df_2022, aes(x = X_L93, y = Y_L93, color = combo)) +
  geom_point(size = 3, alpha = 0.85) +
  scale_color_manual(values = couleurs) +
  coord_equal() +
  theme_carte +
  labs(title = "2022")

# -------------------------------
# 6Ô∏è‚É£ Assembler les deux cartes
# -------------------------------
(carte_2001 + carte_2022) +
  plot_annotation(
    title = "Distribution spatiale de Carex myosuroides et Salix herbacea",
    subtitle = "Comparaison entre 2001 et 2022 dans l'√©cosyst√®me alpin de l'Aravo",
    theme = theme(
      plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
      plot.subtitle = element_text(size = 13, hjust = 0.5)
    )
  )

```


```{r}
library(tidyverse)

df <- read.csv2("final_salix_carex2.0.csv", stringsAsFactors = FALSE)

# Renommer les colonnes pour simplifier
df <- df %>%
  rename(
    Carex = Care.myos,
    Salix = Sali.herb
  )




# V√©rification
unique(df$Year)

# ------------------------
# 2Ô∏è‚É£ Test de cooccurrence s√©par√© par ann√©e
# ------------------------

# --- Pour 2001 ---
df_2001 <- df %>% filter(Year == 2001)
tab_2001 <- table(df_2001$Carex, df_2001$Salix)
tab_2001

test_2001 <- fisher.test(tab_2001)
test_2001

# --- Pour 2022 ---
df_2022 <- df %>% filter(Year == 2022)
tab_2022 <- table(df_2022$Carex, df_2022$Salix)
tab_2022

test_2022 <- fisher.test(tab_2022)
test_2022

# ------------------------
# 3Ô∏è‚É£ R√©sum√© des r√©sultats
# ------------------------
results <- tibble(
  Year = c(2001, 2022),
  p_value = c(test_2001$p.value, test_2022$p.value),
  odds_ratio = c(test_2001$estimate, test_2022$estimate),
  CI_low = c(test_2001$conf.int[1], test_2022$conf.int[1]),
  CI_high = c(test_2001$conf.int[2], test_2022$conf.int[2])
)

print(results)
```

```{r}
# Cr√©er un mod√®le logistique
# Carex ~ Salix + Year
df$Year <- factor(df$Year)  # transformer en facteur si n√©cessaire
model <- glm(Carex ~ Salix * Year, data = df, family = binomial)

summary(model)
```

```{r}
# Probabilit√© de Carex en fonction de Salix et de l'ann√©e (en continu)
df$Year_num <- as.numeric(df$Year)  # si tu veux traiter l'ann√©e comme variable continue
model_trend <- glm(Carex ~ Salix + Year_num, data = df, family = binomial)
summary(model_trend)
```

```{r}
library(ggplot2)
library(dplyr)

# Cr√©er toutes les combinaisons
newdata <- expand.grid(
  Salix = c(0,1),
  Year = factor(c(2001, 2022))
)

# Probabilit√©s pr√©dites
newdata$prob <- predict(model, newdata, type = "response")

# Graphique
ggplot(newdata, aes(x = Year, y = prob, color = factor(Salix), group = Salix)) +
  geom_point(size = 3) +
  geom_line() +
  labs(x = "Ann√©e", y = "Probabilit√© de Carex",
       color = "Salix") +
  theme_minimal()
```








```{r}
library(ggplot2)

ggplot(results, aes(x = factor(Year), y = odds_ratio)) +
  geom_point(color = "blue", size = 3) +                      # points
  geom_errorbar(aes(ymin = CI_low, ymax = CI_high),           # barres d'erreur
                width = 0.1, color = "blue") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "red") + # ligne OR = 1
  ylim(0, max(results$CI_high) + 0.5) +
  labs(
    x = "Ann√©e",
    y = "Odds Ratio (OR)",
    title = "Cooccurrence Carex & Salix"
  ) +
  theme_minimal()
```











```{r}
Presence.combined
```





```{r}
chk.REL
```

```{r}
chk.SIT
```


```{r}
library(dplyr)
library(ggplot2)

# Calculer le nombre de relev√©s communs par ann√©e
evolution <- Presence.combined %>%
  left_join(chk.SIT %>% dplyr::select(id_releve, YR.REL), by = "id_releve") %>%
  filter(!is.na(YR.REL)) %>%
  group_by(YR.REL) %>%
  summarise(n_communs = sum(both_species),
            n_total = n(),
            prop_communs = n_communs / n_total)

# Graphique du nombre de relev√©s communs par ann√©e
ggplot(evolution, aes(x = YR.REL, y = n_communs)) +
  geom_line(color = "darkgreen") +
  geom_point(color = "darkgreen") +
  theme_minimal() +
  labs(title = "√âvolution des relev√©s communs Carex & Salix par ann√©e",
       x = "Ann√©e",
       y = "Nombre de relev√©s communs")
```


```{r}
ggplot(evolution, aes(x = YR.REL, y = prop_communs)) +
  geom_line(color = "darkblue") +
  geom_point(color = "darkblue") +
  theme_minimal() +
  labs(title = "Proportion de relev√©s avec Carex & Salix par ann√©e",
       x = "Ann√©e",
       y = "Proportion de relev√©s communs")
```

```{r}
ggplot(evolution, aes(x = YR.REL, y = prop_communs)) +
  geom_point(color = "darkblue") +
  geom_smooth(method = "loess", color = "red") +
  theme_minimal() +
  labs(title = "Tendance des co-occurrences Carex & Salix",
       x = "Ann√©e",
       y = "Proportion de relev√©s communs")
```

```{r}
library(dplyr)
library(ggplot2)

# --- Cr√©er une table avec les ann√©es et pr√©sence des esp√®ces ---
evolution_full <- Presence.combined %>%
  left_join(chk.SIT %>% dplyr::select(id_releve, YR.REL), by = "id_releve") %>%
  filter(!is.na(YR.REL)) %>%
  group_by(YR.REL) %>%
  summarise(
    n_carex_only = sum(Carex_present == 1 & Salix_present == 0),
    n_salix_only = sum(Carex_present == 0 & Salix_present == 1),
    n_both = sum(both_species == 1)
  ) %>%
  tidyr::pivot_longer(
    cols = c(n_carex_only, n_salix_only, n_both),
    names_to = "type",
    values_to = "count"
  )

# --- Visualisation ---
ggplot(evolution_full, aes(x = YR.REL, y = count, color = type)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  theme_minimal() +
  scale_color_manual(
    values = c("n_carex_only" = "green", "n_salix_only" = "blue", "n_both" = "red"),
    labels = c("Carex seul", "Salix seul", "Les deux esp√®ces")
  ) +
  labs(
    title = "√âvolution des relev√©s Carex, Salix et communs par ann√©e",
    x = "Ann√©e",
    y = "Nombre de relev√©s",
    color = "Type de relev√©"
  ) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```
# V√©rification des effectifs par an 

```{r}
library(dplyr)
library(ggplot2)

# --- V√©rifier le nombre de relev√©s par ann√©e ---
releves_par_an <- Presence.combined %>%
  left_join(chk.SIT %>% dplyr::select(id_releve, YR.REL), by = "id_releve") %>%
  count(YR.REL)

# --- Visualisation ---
ggplot(releves_par_an, aes(x = YR.REL, y = n)) +
  geom_col(fill = "steelblue") +
  theme_minimal() +
  labs(
    title = "Nombre de relev√©s par ann√©e",
    x = "Ann√©e",
    y = "Nombre de relev√©s"
  )
```

```{r}
ggplot(chk.SIT, aes(x = x_l93, y = y_l93, color = as.factor(YR.REL))) +
  geom_point() +
  theme_minimal() +
  labs(title = "R√©partition spatiale des relev√©s au fil du temps",
       x = "X L93", y = "Y L93", color = "Ann√©e")
```


```{r}
library(dplyr)

# --- 1. Ajouter altitudes, ann√©es ET coordonn√©es depuis chk.SIT (Carex) et Sal.SIT (Salix) ---
Presence.combined <- Presence.combined %>%
  left_join(
    chk.SIT %>%
      dplyr::select(id_releve, ELEV, YR.REL, x_l93, y_l93) %>%
      rename(
        ELEV_carex = ELEV,
        YEAR_carex = YR.REL,
        x_l93_carex = x_l93,
        y_l93_carex = y_l93
      ),
    by = "id_releve"
  ) %>%
  left_join(
    Sal.SIT %>%
      dplyr::select(id_releve, ELEV, YR.REL, x_l93, y_l93) %>%
      rename(
        ELEV_salix = ELEV,
        YEAR_salix = YR.REL,
        x_l93_salix = x_l93,
        y_l93_salix = y_l93
      ),
    by = "id_releve"
  ) %>%
  # --- 2. Fusion des colonnes ---
  mutate(
    ELEV = coalesce(ELEV_carex, ELEV_salix),
    YR.REL = coalesce(YEAR_carex, YEAR_salix),
    x_l93 = coalesce(x_l93_carex, x_l93_salix),
    y_l93 = coalesce(y_l93_carex, y_l93_salix)
  )

# --- 3. V√©rification rapide ---
cat("‚úÖ Fusion termin√©e :", nrow(Presence.combined), "relev√©s\n")
cat("Colonnes disponibles :\n")
print(names(Presence.combined))

# --- 4. Enregistrement du fichier CSV ---
# D√©tecte automatiquement le r√©pertoire o√π se trouve ton script
output_path <- file.path(dirname(rstudioapi::getActiveDocumentContext()$path),
                         "Presence_combined_with_coords.csv")

write.csv(Presence.combined, output_path, row.names = FALSE)

cat("üíæ Fichier enregistr√© √† l'emplacement suivant :\n", output_path, "\n")

```




```{r}
Presence.combined
```



```{r}
library(dplyr)

# --- 1. Identifier les id communs entre les deux jeux de donn√©es ---
intersect_ids <- intersect(chk.SIT$id_releve, Sal.SIT$id_releve)
cat("Nombre de relev√©s communs :", length(intersect_ids), "\n")


# --- Red√©finir les s√©lections avec dplyr::select() explicite pour √©viter les conflits ---
compare_sites <- chk.SIT %>%
  dplyr::filter(id_releve %in% intersect_ids) %>%
  dplyr::select(id_releve, ELEV, YR.REL, x_l93, y_l93) %>%
  dplyr::left_join(
    Sal.SIT %>%
      dplyr::select(id_releve, ELEV, YR.REL, x_l93, y_l93),
    by = "id_releve",
    suffix = c("_carex", "_salix")
  )

# --- V√©rification des diff√©rences ---
nb_diff_elev <- sum(compare_sites$ELEV_carex != compare_sites$ELEV_salix, na.rm = TRUE)
nb_diff_year <- sum(compare_sites$YR.REL_carex != compare_sites$YR.REL_salix, na.rm = TRUE)

cat("Diff√©rences d'altitude :", nb_diff_elev, "\n")
cat("Diff√©rences d'ann√©e :", nb_diff_year, "\n")
# --- 3. V√©rification des diff√©rences ---
nb_diff_elev <- sum(compare_sites$ELEV_carex != compare_sites$ELEV_salix, na.rm = TRUE)
nb_diff_year <- sum(compare_sites$YR.REL_carex != compare_sites$YR.REL_salix, na.rm = TRUE)

cat("Diff√©rences d'altitude :", nb_diff_elev, "\n")
cat("Diff√©rences d'ann√©e :", nb_diff_year, "\n")

```



```{r}
glm_carex <- glm(Carex_present ~ ELEV + YR.REL, data = Presence.combined, family = binomial)
glm_salix <- glm(Salix_present ~ ELEV + YR.REL, data = Presence.combined, family = binomial)

summary(glm_carex)
summary(glm_salix)
```

```{r}
overdisp_fun <- function(model) {
  rdf <- df.residual(model)
  rp <- residuals(model, type = "pearson")
  Pearson.chisq <- sum(rp^2)
  prat <- Pearson.chisq / rdf
  pval <- pchisq(Pearson.chisq, df = rdf, lower.tail = FALSE)
  c(chisq = Pearson.chisq, ratio = prat, rdf = rdf, p = pval)
}

overdisp_fun(glm_carex)
overdisp_fun(glm_salix)
```

```{r}
exp(coef(glm_carex))
exp(coef(glm_salix))
```


# glm effet altitude, temps et effet combin√©

```{r}
glm_alt <- glm(both_species ~ ELEV, data = Presence.combined, family = binomial)
summary(glm_alt)
```
```{r}
glm_time <- glm(both_species ~ YR.REL, data = Presence.combined, family = binomial)
summary(glm_time)
```

```{r}
glm_both <- glm(both_species ~ ELEV + YR.REL, data = Presence.combined, family = binomial)
summary(glm_both)
```












```{r}
library(ggplot2)

ggplot(Presence.combined, aes(x = x_l93, y = y_l93)) +
  geom_point(aes(color = factor(Carex_present)), size = 3, alpha = 0.7) +
  scale_color_manual(values = c("0" = "grey70", "1" = "darkgreen"),
                     name = "Carex myosuroides",
                     labels = c("Absent", "Pr√©sent")) +
  coord_equal() +
  theme_minimal() +
  labs(title = "R√©partition spatiale de Carex myosuroides",
       x = "Coordonn√©e X (L93)",
       y = "Coordonn√©e Y (L93)")
```

```{r}
library(ggplot2)

ggplot(Presence.combined, aes(x = x_l93, y = y_l93)) +
  geom_point(aes(color = factor(Salix_present)), size = 3, alpha = 0.7) +
  scale_color_manual(values = c("0" = "grey70", "1" = "darkgreen"),
                     name = "Salix herbaceae",
                     labels = c("Absent", "Pr√©sent")) +
  coord_equal() +
  theme_minimal() +
  labs(title = "R√©partition spatiale de Carex myosuroides",
       x = "Coordonn√©e X (L93)",
       y = "Coordonn√©e Y (L93)")
```

```{r}
Presence.combined <- Presence.combined %>%
  mutate(status = case_when(
    Carex_present == 1 & Salix_present == 1 ~ "Co-occurrence",
    Carex_present == 1 & Salix_present == 0 ~ "Carex seul",
    Carex_present == 0 & Salix_present == 1 ~ "Salix seul",
    TRUE ~ "Aucune"
  ))

ggplot(Presence.combined, aes(x = x_l93, y = y_l93, color = status)) +
  geom_point(size = 3, alpha = 0.8) +
  scale_color_manual(values = c("Co-occurrence" = "purple",
                                "Carex seul" = "darkgreen",
                                "Salix seul" = "orange",
                                "Aucune" = "grey70")) +
  coord_equal() +
  theme_minimal() +
  labs(title = "Distribution spatiale des associations Carex / Salix",
       x = "Coordonn√©e X (L93)", y = "Coordonn√©e Y (L93)",
       color = "Pr√©sence")
```

```{r}
ggplot(Presence.combined, aes(x = x_l93, y = y_l93, color = ELEV)) +
  geom_point(size = 3) +
  scale_color_viridis_c() +
  theme_minimal() +
  labs(title = "Altitude des relev√©s (Carex / Salix)",
       x = "Coordonn√©e X (L93)", y = "Coordonn√©e Y (L93)",
       color = "Altitude (m)")
```
```{r}
library(ggplot2)

Presence.combined <- Presence.combined %>%
  mutate(both_species = as.factor(both_species))

ggplot(Presence.combined, aes(x = x_l93, y = y_l93)) +
  geom_point(aes(color = ELEV, shape = both_species), size = 3, alpha = 0.8) +
  scale_color_viridis_c(option = "plasma", name = "Altitude (m)") +
  scale_shape_manual(
    values = c("0" = 16, "1" = 17),
    name = "Co-occurrence",
    labels = c("Aucune co-occurrence", "Carex + Salix")
  ) +
  theme_minimal() +
  labs(
    title = "R√©partition spatiale Carex / Salix selon l'altitude",
    x = "Coordonn√©e X (L93)",
    y = "Coordonn√©e Y (L93)"
  ) +
  theme(
    legend.position = "right",
    legend.box = "vertical"
  )

```

```{r}
ggplot(Presence.combined, aes(x = x_l93, y = y_l93, color = as.factor(YR.REL))) +
  geom_point(size = 3) +
  scale_color_viridis_d() +
  theme_minimal() +
  labs(title = "√âvolution spatiale des relev√©s au fil du temps",
       x = "Coordonn√©e X (L93)",
       y = "Coordonn√©e Y (L93)",
       color = "Ann√©e du relev√©")
```




```{r}
library(ggplot2)
library(dplyr)

Presence.combined %>%
  filter(!is.na(ELEV)) %>%
  mutate(both_species = as.factor(both_species)) %>%
  ggplot(aes(x = both_species, y = ELEV, fill = both_species)) +
  geom_boxplot(alpha = 0.7) +
  scale_fill_manual(values = c("0" = "lightgrey", "1" = "purple"),
                    labels = c("Non co-occurents", "Co-occurents"),
                    name = "Carex + Salix") +
  theme_minimal() +
  labs(
    title = "Altitude selon la co-occurrence Carex / Salix",
    x = "Co-occurrence",
    y = "Altitude (m)"
  )
```
```{r}
library(ggplot2)
library(dplyr)
library(ggpubr)  # Pour annoter les p-values sur les graphes

# --- 1. Pr√©paration des donn√©es ---
data_alt <- Presence.combined %>%
  filter(!is.na(ELEV)) %>%
  mutate(both_species = as.factor(both_species))

# --- 2. Test statistique automatique ---
# V√©rification de la normalit√©
shapiro_test_0 <- shapiro.test(data_alt$ELEV[data_alt$both_species == "0"])
shapiro_test_1 <- shapiro.test(data_alt$ELEV[data_alt$both_species == "1"])

if (shapiro_test_0$p.value > 0.05 & shapiro_test_1$p.value > 0.05) {
  test_result <- t.test(ELEV ~ both_species, data = data_alt)
  test_label <- paste0("t-test p = ", signif(test_result$p.value, 3))
  cat("Test t de Student : p =", test_result$p.value, "\n")
} else {
  test_result <- wilcox.test(ELEV ~ both_species, data = data_alt)
  test_label <- paste0("Wilcoxon p = ", signif(test_result$p.value, 3))
  cat("Test de Wilcoxon : p =", test_result$p.value, "\n")
}

# --- 3. Boxplot avec annotation ---
ggplot(data_alt, aes(x = both_species, y = ELEV, fill = both_species)) +
  geom_boxplot(alpha = 0.7, width = 0.6) +
  scale_fill_manual(
    values = c("0" = "lightgrey", "1" = "purple"),
    labels = c("Non co-occurents", "Co-occurents"),
    name = "Carex + Salix"
  ) +
  theme_minimal(base_size = 14) +
  labs(
    title = "Altitude selon la co-occurrence Carex / Salix",
    x = "Co-occurrence",
    y = "Altitude (m)"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "none"
  ) +
  stat_compare_means(
    method = ifelse(shapiro_test_0$p.value > 0.05 & shapiro_test_1$p.value > 0.05, "t.test", "wilcox.test"),
    label = "p.format",
    label.y = max(data_alt$ELEV, na.rm = TRUE) * 1.05
  )

```
# Nous avons compar√© les altitudes des relev√©s co-occurents (Carex myosuroides + Salix herbacea) et non co-occurents √† l‚Äôaide d‚Äôun test de Wilcoxon/t-test. La diff√©rence est [significative / non significative] (p = 0,0029)


# Ici on mod√©lise la probabilit√© d‚Äôavoir les deux esp√®ces pr√©sentes en fonction de l‚Äôaltitude (optionnellement aussi de l‚Äôann√©e).

```{r}
# GLM logistique
glm_alt <- glm(both_species ~ ELEV, data = Presence.combined, family = binomial)

summary(glm_alt)
```
on a une augmentation de la co-occurence avec l'altitude 

```{r}
glm_alt_year <- glm(both_species ~ ELEV + YR.REL, 
                    data = Presence.combined, family = binomial)
summary(glm_alt_year)
```
# l'ann√©e a aussi un effet significatif sur la co-occurence. Plus les ann√©es passe est mains il y a de co-occurence ( √† v√©rifier)






--> test de co-occurence en fonction du temps √† √©crire 


```{r}
library(ggplot2)
library(dplyr)
library(tidyr)

# --- 1. V√©rification de la variable ann√©e ---
summary(Presence.combined$YR.REL)
# Si tu veux filtrer les ann√©es extr√™mes ou incoh√©rentes, tu peux faire :
# Presence.combined <- Presence.combined %>% filter(YR.REL >= 1980)

# --- 2. Mod√®les logistiques pour chaque esp√®ce ---
glm_carex_year <- glm(Carex_present ~ YR.REL,
                      data = Presence.combined,
                      family = binomial)

glm_salix_year <- glm(Salix_present ~ YR.REL,
                      data = Presence.combined,
                      family = binomial)

# --- 3. Cr√©ation du jeu de donn√©es pour pr√©dictions ---
newdata_year <- data.frame(YR.REL = seq(min(Presence.combined$YR.REL, na.rm = TRUE),
                                        max(Presence.combined$YR.REL, na.rm = TRUE),
                                        length.out = 200))

newdata_year$Carex_pred <- predict(glm_carex_year, newdata = newdata_year, type = "response")
newdata_year$Salix_pred <- predict(glm_salix_year, newdata = newdata_year, type = "response")

# --- 4. Mise en forme longue pour ggplot ---
pred_df_year <- newdata_year %>%
  pivot_longer(cols = c(Carex_pred, Salix_pred),
               names_to = "Species",
               values_to = "Probability") %>%
  mutate(Species = case_when(
    Species == "Carex_pred" ~ "Carex myosuroides",
    Species == "Salix_pred" ~ "Salix herbacea",
    TRUE ~ Species
  ))

# --- 5. Visualisation temporelle ---
ggplot(pred_df_year, aes(x = YR.REL, y = Probability, color = Species)) +
  geom_line(size = 1.3) +
  geom_point(
    data = Presence.combined %>%
      pivot_longer(cols = c(Carex_present, Salix_present),
                   names_to = "Species",
                   values_to = "Presence") %>%
      mutate(Species = case_when(
        Species == "Carex_present" ~ "Carex myosuroides",
        Species == "Salix_present" ~ "Salix herbacea",
        TRUE ~ Species
      )),
    aes(x = YR.REL, y = Presence),
    alpha = 0.2, size = 1
  ) +
  theme_minimal(base_size = 13) +
  labs(
    title = "√âvolution temporelle de la probabilit√© de pr√©sence",
    subtitle = "Mod√®le logistique binomial (Carex vs Salix)",
    x = "Ann√©e de relev√©",
    y = "Probabilit√© de pr√©sence",
    color = "Esp√®ce"
  ) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "top"
  )

```


```{r}
glm_cooc_year <- glm(both_species ~ YR.REL,
                     data = Presence.combined,
                     family = binomial)

summary(glm_cooc_year)

# Visualisation
new_cooc <- data.frame(YR.REL = seq(min(Presence.combined$YR.REL, na.rm = TRUE),
                                    max(Presence.combined$YR.REL, na.rm = TRUE),
                                    length.out = 200))
new_cooc$prob_cooc <- predict(glm_cooc_year, newdata = new_cooc, type = "response")

ggplot() +
  geom_point(data = Presence.combined, aes(x = YR.REL, y = both_species),
             alpha = 0.3, color = "grey40") +
  geom_line(data = new_cooc, aes(x = YR.REL, y = prob_cooc),
            color = "purple", size = 1.2) +
  theme_minimal() +
  labs(
    title = "√âvolution temporelle de la co-occurrence Carex / Salix",
    subtitle = "Mod√®le logistique binomial",
    x = "Ann√©e de relev√©",
    y = "Probabilit√© de co-occurrence"
  )

```


```{r}
library(dplyr)
library(tidyr)
library(ggplot2)

# --- 1. Pr√©parer les donn√©es en format long ---
df_long <- Presence.combined %>%
  dplyr::select(id_releve, YR.REL, Carex_present, Salix_present) %>%
  tidyr::pivot_longer(
    cols = c(Carex_present, Salix_present),
    names_to = "Species",
    values_to = "Presence"
  ) %>%
  dplyr::mutate(
    Species = dplyr::case_when(
      Species == "Carex_present" ~ "Carex myosuroides",
      Species == "Salix_present" ~ "Salix herbacea",
      TRUE ~ Species
    )
  )

# --- 2. Mod√®le logistique combin√© (ann√©e √ó esp√®ce) ---
glm_species_time <- glm(
  Presence ~ YR.REL * Species,
  data = df_long,
  family = binomial
)

summary(glm_species_time)

# --- 3. Pr√©dictions et visualisation ---
new_pred <- expand.grid(
  YR.REL = seq(min(Presence.combined$YR.REL, na.rm = TRUE),
               max(Presence.combined$YR.REL, na.rm = TRUE),
               length.out = 200),
  Species = c("Carex myosuroides", "Salix herbacea")
)

new_pred$Probability <- predict(glm_species_time, newdata = new_pred, type = "response")

# --- 4. Graphique final ---
ggplot(new_pred, aes(x = YR.REL, y = Probability, color = Species)) +
  geom_line(size = 1.3) +
  geom_point(data = df_long, aes(x = YR.REL, y = Presence, color = Species),
             alpha = 0.2, size = 1) +
  theme_minimal(base_size = 13) +
  labs(
    title = "Comparaison de la tendance temporelle de pr√©sence",
    subtitle = "Mod√®le logistique avec interaction (ann√©e √ó esp√®ce)",
    x = "Ann√©e de relev√©",
    y = "Probabilit√© de pr√©sence",
    color = "Esp√®ce"
  ) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "top"
  )


```




```{r}
library(ggplot2)
library(dplyr)
library(tidyr)

# --- 2. Jeu de donn√©es pour pr√©dictions ---
newdata <- data.frame(ELEV = seq(min(Presence.combined$ELEV, na.rm = TRUE),
                                 max(Presence.combined$ELEV, na.rm = TRUE),
                                 length.out = 200))

newdata$Carex_pred <- predict(glm_carex, newdata = newdata, type = "response")
newdata$Salix_pred <- predict(glm_salix, newdata = newdata, type = "response")

# --- 3. Mise en forme longue pour ggplot ---
pred_df <- newdata %>%
  pivot_longer(cols = c(Carex_pred, Salix_pred),
               names_to = "Species",
               values_to = "Probability") %>%
  mutate(Species = case_when(
    Species == "Carex_pred" ~ "Carex myosuroides",
    Species == "Salix_pred" ~ "Salix herbacea",
    TRUE ~ Species
  ))

# --- 4. Visualisation ---
ggplot(pred_df, aes(x = ELEV, y = Probability, color = Species)) +
  geom_line(size = 1.3) +
  geom_point(
    data = Presence.combined %>%
      pivot_longer(cols = c(Carex_present, Salix_present),
                   names_to = "Species",
                   values_to = "Presence") %>%
      mutate(Species = case_when(
        Species == "Carex_present" ~ "Carex myosuroides",
        Species == "Salix_present" ~ "Salix herbacea",
        TRUE ~ Species
      )),
    aes(x = ELEV, y = Presence),
    alpha = 0.2, size = 1
  ) +
  theme_minimal(base_size = 13) +
  labs(
    title = "Effet de l'altitude sur la probabilit√© de pr√©sence",
    subtitle = "Mod√®le logistique binomial",
    x = "Altitude (m)",
    y = "Probabilit√© de pr√©sence",
    color = "Esp√®ce"
  ) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "top"
  )

```



--> arranger les datas pour les analyse de Aravo 




 # v√©rification 


```{r}
library(ggplot2)

ggplot(Presence.combined, aes(x = x_l93, y = y_l93)) +
  geom_point(aes(color = factor(both_species), size = ELEV), alpha = 0.8) +
  scale_color_manual(values = c("0" = "grey70", "1" = "purple"),
                     name = "Co-occurrence Carex/Salix",
                     labels = c("Non", "Oui")) +
  theme_minimal(base_size = 13) +
  labs(title = "R√©partition spatiale des relev√©s (Carex & Salix)",
       x = "Coordonn√©e X (L93)", y = "Coordonn√©e Y (L93)", size = "Altitude (m)")

```


```{r}
newdata <- data.frame(ELEV = seq(min(Presence.combined$ELEV, na.rm = TRUE),
                                 max(Presence.combined$ELEV, na.rm = TRUE), length.out = 200))

newdata$pred <- predict(glm_alt, newdata = newdata, type = "response")

ggplot(newdata, aes(x = ELEV, y = pred)) +
  geom_line(color = "purple", size = 1.2) +
  theme_minimal(base_size = 13) +
  labs(title = "Effet de l'altitude sur la probabilit√© de cooccurrence",
       x = "Altitude (m)", y = "Probabilit√© pr√©dite")



```

```{r}

```

# le code ci dessous est cens√© donner la m√™me chose que celui ci dessus bizzare  v√©rifier 

```{r}
library(ggplot2)

ggplot(Presence.combined, aes(x = ELEV, y = both_species)) +
  geom_jitter(height = 0.05, width = 0, alpha = 0.2, color = "grey40") +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), 
              se = TRUE, color = "purple", size = 1.2) +
  theme_minimal() +
  labs(
    title = "Effet de l‚Äôaltitude sur la probabilit√© de co-occurrence Carex / Salix",
    x = "Altitude (m)",
    y = "Probabilit√© de co-occurrence"
  )
```

`
```{r}
library(ggplot2)

Presence.combined <- Presence.combined %>%
  mutate(
    both_species = as.numeric(as.character(both_species)),
    YR.REL = as.numeric(as.character(YR.REL))
  )

Presence.combined %>%
  group_by(YR.REL) %>%
  summarise(
    n_total = n(),
    n_cooc = sum(both_species, na.rm = TRUE),
    prop_cooc = n_cooc / n_total
  ) %>%
  ggplot(aes(x = YR.REL, y = prop_cooc)) +
  geom_line(color = "purple", linewidth = 1.2) +
  geom_point(color = "purple", size = 2) +
  theme_minimal(base_size = 13) +
  labs(title = "√âvolution de la cooccurrence Carex / Salix dans le temps",
       x = "Ann√©e", y = "Proportion de cooccurrence")
```

```{r}
Presence.combined
```



```{r}
library(ggpubr)
library(dplyr)

# V√©rification de la variable
table(Presence.combined$both_species)

# Boxplot + test de Wilcoxon
ggboxplot(Presence.combined,
          x = "both_species",
          y = "ELEV",
          fill = "both_species",
          palette = c("grey", "purple"),
          xlab = "Co-occurrence (0 = non, 1 = oui)",
          ylab = "Altitude (m)",
          title = "Altitude selon la co-occurrence Carex / Salix") +
  stat_compare_means(
    aes(group = both_species),
    method = "wilcox.test",
    label = "p.format",
    label.y = max(Presence.combined$ELEV, na.rm = TRUE) * 0.95
  ) +
  theme_minimal(base_size = 13)

```


# comparaison compl√©mentaire 

changement de zone d'√©chantillonage 


```{r}
cor.test(Presence.combined$ELEV, Presence.combined$YR.REL, use="complete.obs")
```


```{r}
ggplot(Presence.combined, aes(x=YR.REL, y=ELEV)) + geom_boxplot() + theme_minimal()
```

# Robustesse bootstrap


```{r}
install.packages("car")


library(boot)

# example bootstrap for a single year (wrap in lapply for all years)
boot_prop <- function(data, i) {
  d <- data[i,]
  mean(d$both_species)
}
res_boot <- boot(data = Presence.combined %>% filter(YR.REL==2000), statistic = boot_prop, R=1000)
boot.ci(res_boot, type="perc")

```
```{r}
Presence.combined <- Presence.combined %>%
  mutate(type = case_when(
    Carex_present==1 & Salix_present==1 ~ "Both",
    Carex_present==1 & Salix_present==0 ~ "Carex_only",
    Carex_present==0 & Salix_present==1 ~ "Salix_only",
    TRUE ~ "None"
  ))

ggplot(Presence.combined, aes(x=x_l93, y=y_l93, color=type)) +
  geom_point(alpha=0.8, size=2) +
  theme_minimal() + coord_equal() +
  labs(title="R√©partition spatiale : Carex / Salix / Both")
```


```{r}
library(ggplot2)
ggplot(Presence.combined %>% filter(type=="Both"), aes(x=x_l93, y=y_l93)) +
  stat_density_2d(aes(fill = ..level..), geom="polygon", alpha=0.6) +
  geom_point(color="red", size=1) +
  theme_minimal() +
  labs(title="Densit√© des relev√©s communs (Both)")
```

--> chercher comment interpr√©ter 

```{r}
Presence.combined <- Presence.combined %>% mutate(period = cut(YR.REL, breaks=seq(1989, 2025, by=5)))
ggplot(Presence.combined %>% filter(!is.na(period)), aes(x=x_l93, y=y_l93, color=type)) +
  geom_point(size=1) +
  facet_wrap(~period) + coord_equal() + theme_minimal()
```


```{r}

cooccur_tests <- Presence.combined %>%
  group_by(YR.REL) %>%
  summarise(
    a = sum(Carex_present==1 & Salix_present==1), # both
    b = sum(Carex_present==1 & Salix_present==0),
    c = sum(Carex_present==0 & Salix_present==1),
    d = sum(Carex_present==0 & Salix_present==0)
  ) %>%
  rowwise() %>%
  mutate(
    fisher_p = fisher.test(matrix(c(a,b,c,d),2,2))$p.value,
    or = ifelse((b*c)==0, NA, (a*d)/(b*c))
  )

# show years with significant cooccurrence (beware multiple testing)
cooccur_tests %>% arrange(fisher_p) %>% head()
```
```{r}
Presence.combined <- Presence.combined %>% mutate(decade = (YR.REL %/% 10) * 10)
decade_tab <- Presence.combined %>%
  group_by(decade) %>%
  summarise(n_total = n(), n_both = sum(both_species==1)) %>%
  mutate(prop = n_both / n_total)

ggplot(decade_tab, aes(x=factor(decade), y=prop)) +
  geom_col(fill="tomato") +
  labs(title="Proportion de cooccurrence par d√©cade", x="D√©cade", y="Prop. both")
```
```{r}
releves_par_an <- Presence.combined %>%
  count(YR.REL) %>% arrange(YR.REL)

# histogramme
ggplot(releves_par_an, aes(x = YR.REL, y = n)) +
  geom_col(fill="steelblue") +
  theme_minimal() +
  labs(title="Nombre de relev√©s par ann√©e", x="Ann√©e", y="Nombre de relev√©s")
```

--> voir le code 2 dans to do chat gpt

```{r}
# -------------------------------
# 1Ô∏è‚É£ Packages n√©cessaires
# -------------------------------
library(tidyverse)

# -------------------------------
# 2Ô∏è‚É£ Pr√©paration des donn√©es
# -------------------------------
df <- Presence.combined %>%
  mutate(
    Carex = as.numeric(Carex_present),
    Salix = as.numeric(Salix_present),
    ELEV = as.numeric(ELEV)
  )

# V√©rifie rapidement que tout est bien en place :
glimpse(df)

# -------------------------------
# 3Ô∏è‚É£ Calcul de l‚Äôaltitude moyenne / m√©diane de pr√©sence
# -------------------------------
alt_optimum <- df %>%
  pivot_longer(cols = c(Carex, Salix), names_to = "Espece", values_to = "Presence") %>%
  filter(Presence == 1) %>%
  group_by(Espece) %>%
  summarise(
    Altitude_moyenne = mean(ELEV, na.rm = TRUE),
    Altitude_mediane = median(ELEV, na.rm = TRUE),
    Altitude_min = min(ELEV, na.rm = TRUE),
    Altitude_max = max(ELEV, na.rm = TRUE),
    n_releves = n()
  )

print(alt_optimum)



# -------------------------------
# 4Ô∏è‚É£ Visualisation ‚Äî histogrammes
# -------------------------------
ggplot(
  df %>%
    pivot_longer(cols = c(Carex, Salix), names_to = "Espece", values_to = "Presence"),
  aes(x = ELEV, fill = as.factor(Presence))
) +
  geom_histogram(binwidth = 50, position = "stack", color = "white") +
  facet_wrap(~Espece, ncol = 1) +
  scale_fill_manual(
    values = c("0" = "grey80", "1" = "#0072B2"),
    labels = c("Absence", "Pr√©sence"),
    name = ""
  ) +
  theme_minimal(base_size = 13) +
  labs(
    title = "Distribution altitudinale de Carex myosuroides et Salix herbacea",
    subtitle = "Pr√©sence en fonction de l'altitude (ELEV) ‚Äî estimation des optimums √©cologiques",
    x = "Altitude (m)",
    y = "Nombre de relev√©s"
  )

# -------------------------------
# 5Ô∏è‚É£ Visualisation alternative ‚Äî densit√©
# -------------------------------
ggplot(
  df %>%
    pivot_longer(cols = c(Carex, Salix), names_to = "Espece", values_to = "Presence") %>%
    filter(Presence == 1),
  aes(x = ELEV, fill = Espece, color = Espece)
) +
  geom_density(alpha = 0.4) +
  scale_fill_manual(values = c("Carex" = "#E69F00", "Salix" = "#0072B2")) +
  scale_color_manual(values = c("Carex" = "#E69F00", "Salix" = "#0072B2")) +
  theme_minimal(base_size = 13) +
  labs(
    title = "Optimum √©cologique altitudinal",
    subtitle = "Distribution des pr√©sences selon l‚Äôaltitude (ELEV)",
    x = "Altitude (m)",
    y = "Densit√© de pr√©sence"
  )

```


```{r}
Presence.combined
```

# TEST ARAVO SALIX ET CAREX 

```{r}
# --- Chargement des librairies ---
library(readxl)
library(dplyr)
library(writexl)

# --- 1. Importation du fichier Excel ---
# Remplace le chemin ci-dessous par celui de ton fichier
setwd("~/Desktop/SEAM_Aravo/Rstudio")
fichier <- "REL_ARAVO.xlsx"

meta <- read_excel(fichier, sheet = "META")
rel2001 <- read_excel(fichier, sheet = "2001")
rel2022 <- read_excel(fichier, sheet = "2022")


# --- 2. Conversion des coordonn√©es (si virgules au lieu de points) ---
meta <- meta %>%
  mutate(
    X_L93 = as.numeric(gsub(",", ".", X_L93)),
    Y_L93 = as.numeric(gsub(",", ".", Y_L93))
  )


# --- 2. V√©rification rapide des structures ---
# (optionnel mais utile pour s'assurer que tout est bien lu)
str(meta)
str(rel2001)
str(rel2022)

# --- 3. Identifier les placettes communes ---
id_communs <- intersect(rel2001$ID, rel2022$ID)
cat(length(id_communs), "placettes communes identifi√©es.\n")

# --- 4. Cr√©er REL_APA (placettes appari√©es) ---
REL_APA_2001 <- rel2001 %>%
  filter(ID %in% id_communs) %>%
  left_join(meta, by = "ID")

REL_APA_2022 <- rel2022 %>%
  filter(ID %in% id_communs) %>%
  left_join(meta, by = "ID")

# Si tu veux un seul jeu combin√© pour les donn√©es appari√©es :
REL_APA <- bind_rows(REL_APA_2001, REL_APA_2022)

# --- 5. Cr√©er REL_COM (toutes les placettes) ---
# On garde toutes les placettes, m√™me celles pr√©sentes √† une seule date
REL_COM <- meta %>%
  full_join(rel2001, by = "ID") %>%
  full_join(rel2022, by = "ID", suffix = c("_2001", "_2022"))

# --- 6. V√©rification du r√©sultat ---
cat("REL_COM contient", nrow(REL_COM), "placettes au total.\n")

# --- 7. Export (optionnel) ---
write_xlsx(list(
  REL_APA_2001 = REL_APA_2001,
  REL_APA_2022 = REL_APA_2022,
  REL_APA = REL_APA,
  REL_COM = REL_COM
), "resultats_rel.xlsx")

cat("Fichier 'resultats_rel.xlsx' cr√©√© avec succ√®s ‚úÖ\n")

```



```{r}
REL_APA_2001
```


```{r}
REL_APA_2022
```

```{r}
REL_APA
```

```{r}
REL_COM
```


# A. Co-occurrence intra-annuelle (au sein d‚Äôune m√™me ann√©e)

Tableau de contingence 2√ó2 pour chaque ann√©e ‚Üí test exact de Fisher pour co-occurrence.

```{r}

library(dplyr)
library(cooccur)

# V√©rifier les noms de colonnes
names(REL_APA_2001)

# Assurer que SALIX et CAREX sont num√©riques (0 = absence, 1 = pr√©sence)
REL_APA_2001 <- REL_APA_2001 %>%
  mutate(
    SALIX = as.numeric(SALIX),
    CAREX = as.numeric(CAREX)
  )

# V√©rifier la structure
str(REL_APA_2001)
head(REL_APA_2001)


```

```{r}
library(dplyr)
library(ggplot2)


# --- 2. V√©rifier les colonnes 0/1 ---
REL_APA_2001 <- REL_APA_2001 %>%
  mutate(
    SALIX = ifelse(SALIX > 0, 1, 0),
    CAREX = ifelse(CAREX > 0, 1, 0)
  )

REL_APA_2022 <- REL_APA_2022 %>%
  mutate(
    SALIX = ifelse(SALIX > 0, 1, 0),
    CAREX = ifelse(CAREX > 0, 1, 0)
  )

```



```{r}
# --- 3. Test de co-occurrence intra-annuelle (Fisher) ---
tab_2001 <- table(REL_APA_2001$SALIX, REL_APA_2001$CAREX)
tab_2022 <- table(REL_APA_2022$SALIX, REL_APA_2022$CAREX)

fisher_2001 <- fisher.test(tab_2001)
fisher_2022 <- fisher.test(tab_2022)

print("Co-occurrence 2001 :")
print(tab_2001)
print(fisher_2001)

print("Co-occurrence 2022 :")
print(tab_2022)
print(fisher_2022)

```


```{r}
# --- 4. Test temporel (McNemar) sur placettes appari√©es ---
cooccur_2001 <- REL_APA_2001$SALIX & REL_APA_2001$CAREX
cooccur_2022 <- REL_APA_2022$SALIX & REL_APA_2022$CAREX

table_time <- table(cooccur_2001, cooccur_2022)
mcnemar <- mcnemar.test(table_time)

print("Comparaison temporelle (McNemar) :")
print(table_time)
print(mcnemar)

```

```{r}
# --- 5. Carte de co-occurrence 2001 ---
ggplot(REL_APA_2001) +
  geom_point(aes(x = X_L93, y = Y_L93, color = interaction(SALIX, CAREX))) +
  scale_color_manual(values = c("grey70","blue","green","purple"),
                     labels = c("aucune","SALIX seul","CAREX seul","les deux")) +
  coord_equal() +
  labs(title = "Co-occurrence SALIX & CAREX (2001)")

# --- 6. Carte de co-occurrence 2022 ---
ggplot(REL_APA_2022) +
  geom_point(aes(x = X_L93, y = Y_L93, color = interaction(SALIX, CAREX))) +
  scale_color_manual(values = c("grey70","blue","green","purple"),
                     labels = c("aucune","SALIX seul","CAREX seul","les deux")) +
  coord_equal() +
  labs(title = "Co-occurrence SALIX & CAREX (2022)")
```

```{r}
library(ggplot2)
library(dplyr)

# Ajouter une colonne "cooccur" pour les 4 combinaisons
REL_APA_2001_plot <- REL_APA_2001 %>%
  mutate(cooccur = factor(interaction(SALIX, CAREX),
                          levels = c("0.0","1.0","0.1","1.1"),
                          labels = c("aucune","SALIX seul","CAREX seul","les deux")))

REL_APA_2022_plot <- REL_APA_2022 %>%
  mutate(cooccur = factor(interaction(SALIX, CAREX),
                          levels = c("0.0","1.0","0.1","1.1"),
                          labels = c("aucune","SALIX seul","CAREX seul","les deux")))

# Combiner les deux ann√©es
REL_APA_all <- bind_rows(
  REL_APA_2001_plot %>% mutate(YR = 2001),
  REL_APA_2022_plot %>% mutate(YR = 2022)
)

# Carte combin√©e
ggplot(REL_APA_all) +
  geom_point(aes(x = X_L93, y = Y_L93, color = cooccur)) +
  scale_color_manual(values = c("grey70","blue","green","purple")) +
  facet_wrap(~YR) +
  coord_equal() +
  labs(title = "Co-occurrence SALIX & CAREX (2001 vs 2022)",
       color = "Pr√©sence") +
  theme_minimal()

```

```{r}
library(dplyr)
library(ggplot2)

# 1. Co-occurrence par ann√©e
REL_APA_2001_plot <- REL_APA_2001 %>%
  mutate(cooccur = ifelse(SALIX == 1 & CAREX == 1, 1, 0)) %>%
  dplyr::select(ID, cooccur, X_L93, Y_L93)

REL_APA_2022_plot <- REL_APA_2022 %>%
  mutate(cooccur = ifelse(SALIX == 1 & CAREX == 1, 1, 0)) %>%
  dplyr::select(ID, cooccur)

# 2. Combiner les deux ann√©es
REL_APA_change <- REL_APA_2001_plot %>%
  left_join(REL_APA_2022_plot, by = "ID", suffix = c("_2001","_2022"))

# 3. Cr√©er la variable changement
REL_APA_change <- REL_APA_change %>%
  mutate(changement = case_when(
    cooccur_2001 == 0 & cooccur_2022 == 1 ~ "apparue",
    cooccur_2001 == 1 & cooccur_2022 == 0 ~ "disparue",
    cooccur_2001 == 1 & cooccur_2022 == 1 ~ "toujours pr√©sente",
    cooccur_2001 == 0 & cooccur_2022 == 0 ~ "toujours absente"
  ))

# 4. V√©rification rapide
table(REL_APA_change$changement)

# 5. Carte des changements
ggplot(REL_APA_change) +
  geom_point(aes(x = X_L93, y = Y_L93, color = changement), size = 3) +
  scale_color_manual(values = c("apparue" = "purple",
                                "disparue" = "red",
                                "toujours pr√©sente" = "blue",
                                "toujours absente" = "grey70")) +
  coord_equal() +
  labs(title = "√âvolution de la co-occurrence SALIX & CAREX (2001 ‚Üí 2022)",
       color = "Changement") +
  theme_minimal()


```
```{r}
library(dplyr)
library(ggplot2)

# --- 1. Cr√©er une colonne co-occurrence pour chaque ann√©e ---
REL_APA_2001_plot <- REL_APA_2001 %>%
  mutate(cooccur = ifelse(SALIX == 1 & CAREX == 1, 1, 0))

REL_APA_2022_plot <- REL_APA_2022 %>%
  mutate(cooccur = ifelse(SALIX == 1 & CAREX == 1, 1, 0))

# --- 2. Calculer le pourcentage de placettes avec co-occurrence ---
stats_hist <- bind_rows(
  REL_APA_2001_plot %>% summarise(YR = 2001, pct = 100 * mean(cooccur)),
  REL_APA_2022_plot %>% summarise(YR = 2022, pct = 100 * mean(cooccur))
)

# --- 3. Cr√©er l'histogramme ---
ggplot(stats_hist, aes(x = factor(YR), y = pct, fill = factor(YR))) +
  geom_bar(stat = "identity", width = 0.5) +
  geom_text(aes(label = paste0(round(pct,1),"%")), vjust = -0.5) +
  scale_fill_manual(values = c("2001" = "skyblue", "2022" = "orange")) +
  labs(title = "Pourcentage de placettes avec co-occurrence SALIX & CAREX",
       x = "Ann√©e",
       y = "% de placettes",
       fill = "Ann√©e") +
  ylim(0,100) +
  theme_minimal()

```

# Maintenant je vais travailler avec l'ensemble des donn√©es pour une vision globale 


```{r}
library(dplyr)
library(ggplot2)

# -------------------------------
# 1Ô∏è‚É£ Carte globale REL_COM
# -------------------------------

# Colonnes pr√©sence au moins une ann√©e
REL_COM_plot <- REL_COM %>%
  mutate(
    SALIX = pmax(SALIX_2001, SALIX_2022, na.rm = TRUE),
    CAREX = pmax(CAREX_2001, CAREX_2022, na.rm = TRUE),
    cooccur = case_when(
      SALIX == 1 & CAREX == 1 ~ "les deux",
      SALIX == 1 & CAREX == 0 ~ "SALIX seul",
      SALIX == 0 & CAREX == 1 ~ "CAREX seul",
      TRUE ~ "aucune"
    )
  ) %>%
  filter(!is.na(X_L93) & !is.na(Y_L93)) # Filtrer les NA

# Annotations centr√©es par cat√©gorie
stats_COM_coords <- REL_COM_plot %>%
  group_by(cooccur) %>%
  reframe(
    n = n(),
    pct = round(100*n/nrow(REL_COM_plot),1),
    X_label = mean(X_L93),
    Y_label = mean(Y_L93)
  )

# Carte
ggplot(REL_COM_plot) +
  geom_point(aes(x=X_L93, y=Y_L93, color=cooccur), size=3, alpha=0.7) +
  scale_color_manual(values=c("les deux"="purple","SALIX seul"="blue",
                              "CAREX seul"="green","aucune"="grey70")) +
  coord_equal() +
  labs(title="R√©partition spatiale des placettes (toutes ann√©es)",
       color="Cat√©gorie") +
  theme_minimal()

```


# Avec jeu de donn√©e : REL_APA


```{r}
library(dplyr)
library(ggplot2)

# -------------------------------
# 1Ô∏è‚É£ Pr√©parer les donn√©es REL_APA
# -------------------------------

REL_APA_all_plot <- bind_rows(
  REL_APA_2001 %>% mutate(YR=2001),
  REL_APA_2022 %>% mutate(YR=2022)
) %>%
  mutate(
    cooccur = case_when(
      SALIX == 1 & CAREX == 1 ~ "les deux",
      SALIX == 1 & CAREX == 0 ~ "SALIX seul",
      SALIX == 0 & CAREX == 1 ~ "CAREX seul",
      TRUE ~ "aucune"
    )
  )

# -------------------------------
# 2Ô∏è‚É£ Calculer statistiques pour barplot
# -------------------------------

stats_APA <- REL_APA_all_plot %>%
  group_by(YR, cooccur) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(YR) %>%
  mutate(pct = 100 * n / sum(n))

# -------------------------------
# 3Ô∏è‚É£ Stacked barplot
# -------------------------------

ggplot(stats_APA, aes(x = factor(YR), y = pct, fill = cooccur)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(round(pct,1),"%")), 
            position = position_stack(vjust = 0.5), color = "white", size = 4) +
  scale_fill_manual(values = c("les deux"="purple",
                               "SALIX seul"="blue",
                               "CAREX seul"="green",
                               "aucune"="grey70")) +
  labs(title = "Distribution des cat√©gories de co-occurrence (placettes communes)",
       x = "Ann√©e",
       y = "% de placettes",
       fill = "Cat√©gorie") +
  theme_minimal()

```

```{r}
# Enregistrer REL_APA en CSV dans le m√™me dossier que le script
write.csv(REL_APA, "REL_APA.csv", row.names = FALSE)
```


